<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="https://cdn.jsdelivr.net/gh/cmyk359/MyCDN/Hexo/static/img/webicon.png"><link rel="icon" href="https://cdn.jsdelivr.net/gh/cmyk359/MyCDN/Hexo/static/img/webicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="猫爪在上"><meta name="keywords" content=""><meta name="description" content="Redis集群 本章是基于CentOS7下的Redis集群教程，包括：  单机安装Redis Redis主从 Redis分片集群  1.单机安装Redis 首先需要安装Redis所需要的依赖： yum install -y gcc tcl 然后将课前资料提供的Redis安装包上传到虚拟机的任意目录：   image-20210629114325516  例如，我放"><meta property="og:type" content="article"><meta property="og:title" content="Redis集群搭建"><meta property="og:url" content="http://catpaws.top/3e4345d9/index.html"><meta property="og:site_name" content="猫爪在上de书桌"><meta property="og:description" content="Redis集群 本章是基于CentOS7下的Redis集群教程，包括：  单机安装Redis Redis主从 Redis分片集群  1.单机安装Redis 首先需要安装Redis所需要的依赖： yum install -y gcc tcl 然后将课前资料提供的Redis安装包上传到虚拟机的任意目录：   image-20210629114325516  例如，我放"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2024-12-24T08:52:03.000Z"><meta property="article:modified_time" content="2025-01-04T16:17:02.256Z"><meta property="article:author" content="猫爪在上"><meta name="twitter:card" content="summary_large_image"><title>Redis集群搭建 - 猫爪在上de书桌</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/cmyk359/MyCDN/Hexo/source/css/font.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/cmyk359/MyCDN/Hexo/source/css/poem.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/shubiao.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"catpaws.top",root:"/",version:"1.9.8",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:{measurement_id:null},tencent:{sid:null,cid:null},leancloud:{app_id:"TNTPv22capMq3aFV9S0sLqSm-gzGzoHsz",app_key:"G2BBAxXmiixopVg5mIJ2sxXR",server_url:"https://tntpv22c.lc-cn-n1-shared.com",path:"window.location.pathname",ignore_local:!1},umami:{src:null,website_id:null,domains:null,start_time:"2024-01-01T00:00:00.000Z",token:null,api_server:null}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 7.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>猫爪在上de书桌</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-addrcard"></i> <span>主页</span></a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-books"></i> <span>博客</span></a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/" target="_self"><i class="iconfont icon-pen"></i> <span>文章</span> </a><a class="dropdown-item" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span> </a><a class="dropdown-item" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span> </a><a class="dropdown-item" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></div></li><li class="nav-item"><a class="nav-link" href="/messages/" target="_self"><i class="iconfont icon-comment"></i> <span>留言板</span></a></li><li class="nav-item"><a class="nav-link" href="/timeline/" target="_self"><i class="iconfont icon-images"></i> <span>时光轴</span></a></li><li class="nav-item"><a class="nav-link" href="/links/" target="_self"><i class="iconfont icon-link-fill"></i> <span>友链</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(https://cdn.jsdelivr.net/gh/cmyk359/MyCDN/Hexo/static/img/article-bg.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="Redis集群搭建"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2024-12-24 16:52" pubdate>2024年12月24日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 2.6k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 22 分钟 </span><span id="leancloud-page-views-container" class="post-meta" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="leancloud-page-views"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">Redis集群搭建</h1><p id="updated-time" class="note note-info">本文最后更新于 2025年1月5日 凌晨</p><div class="markdown-body"><meta name="referrer" , content="no-referrer"><h1 id="redis集群">Redis集群</h1><p>本章是基于CentOS7下的Redis集群教程，包括：</p><ul><li>单机安装Redis</li><li>Redis主从</li><li>Redis分片集群</li></ul><h1 id="单机安装redis">1.单机安装Redis</h1><p>首先需要安装Redis所需要的依赖：</p><div class="code-wrapper"><pre><code class="hljs sh">yum install -y gcc tcl</code></pre></div><p>然后将课前资料提供的Redis安装包上传到虚拟机的任意目录：</p><figure><img src="https://gitee.com/cmyk359/img/raw/master/img/image-20210629114325516-2024-12-2416:49:22.png" srcset="/img/loading.gif" lazyload alt="image-20210629114325516"><figcaption aria-hidden="true">image-20210629114325516</figcaption></figure><p>例如，我放到了/tmp目录：</p><figure><img src="https://gitee.com/cmyk359/img/raw/master/img/image-20210629114830642-2024-12-2416:49:29.png" srcset="/img/loading.gif" lazyload alt="image-20210629114830642"><figcaption aria-hidden="true">image-20210629114830642</figcaption></figure><p>解压缩：</p><div class="code-wrapper"><pre><code class="hljs sh">tar -xzf redis-6.2.4.tar.gz</code></pre></div><p>解压后：</p><figure><img src="https://gitee.com/cmyk359/img/raw/master/img/image-20210629114941810-2024-12-2416:49:34.png" srcset="/img/loading.gif" lazyload alt="image-20210629114941810"><figcaption aria-hidden="true">image-20210629114941810</figcaption></figure><p>进入redis目录：</p><div class="code-wrapper"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> redis-6.2.4</code></pre></div><p>运行编译命令：</p><div class="code-wrapper"><pre><code class="hljs sh">make &amp;&amp; make install</code></pre></div><p>如果没有出错，应该就安装成功了。</p><p>然后修改redis.conf文件中的一些配置：</p><div class="code-wrapper"><pre><code class="hljs properties"><span class="hljs-comment"># 绑定地址，默认是127.0.0.1，会导致只能在本地访问。修改为0.0.0.0则可以在任意IP访问</span>
<span class="hljs-attr">bind</span> <span class="hljs-string">0.0.0.0</span>
<span class="hljs-comment"># 保护模式，关闭保护模式</span>
<span class="hljs-attr">protected-mode</span> <span class="hljs-string">no</span>
<span class="hljs-comment"># 数据库数量，设置为1</span>
<span class="hljs-attr">databases</span> <span class="hljs-string">1</span></code></pre></div><p>启动Redis：</p><div class="code-wrapper"><pre><code class="hljs sh">redis-server redis.conf</code></pre></div><p>停止redis服务：</p><div class="code-wrapper"><pre><code class="hljs sh">redis-cli shutdown</code></pre></div><h1 id="redis主从集群">2.Redis主从集群</h1><h2 id="集群结构">2.1.集群结构</h2><p>我们搭建的主从集群结构如图：</p><figure><img src="https://gitee.com/cmyk359/img/raw/master/img/image-20210630111505799-2024-12-2416:49:40.png" srcset="/img/loading.gif" lazyload alt="image-20210630111505799"><figcaption aria-hidden="true">image-20210630111505799</figcaption></figure><p>搭建的主从集群共包含三个节点，一个主节点，两个从节点。</p><p>这里我们会在同一台虚拟机中开启3个redis实例，模拟主从集群，信息如下：</p><table><thead><tr class="header"><th style="text-align:center">IP</th><th style="text-align:center">PORT</th><th style="text-align:center">角色</th></tr></thead><tbody><tr class="odd"><td style="text-align:center">192.168.150.101</td><td style="text-align:center">7001</td><td style="text-align:center">master</td></tr><tr class="even"><td style="text-align:center">192.168.150.101</td><td style="text-align:center">7002</td><td style="text-align:center">slave</td></tr><tr class="odd"><td style="text-align:center">192.168.150.101</td><td style="text-align:center">7003</td><td style="text-align:center">slave</td></tr></tbody></table><h2 id="准备实例和配置">2.2.准备实例和配置</h2><p>要在同一台虚拟机开启3个实例，必须准备三份不同的配置文件和目录，配置文件所在目录也就是工作目录。</p><p>1）创建目录</p><p>我们创建三个文件夹，名字分别叫7001、7002、7003：</p><div class="code-wrapper"><pre><code class="hljs sh"><span class="hljs-comment"># 进入/tmp目录</span>
<span class="hljs-built_in">cd</span> /tmp
<span class="hljs-comment"># 创建目录</span>
<span class="hljs-built_in">mkdir</span> 7001 7002 7003</code></pre></div><p>如图：</p><figure><img src="https://gitee.com/cmyk359/img/raw/master/img/image-20210630113929868-2024-12-2416:49:44.png" srcset="/img/loading.gif" lazyload alt="image-20210630113929868"><figcaption aria-hidden="true">image-20210630113929868</figcaption></figure><p>2）恢复原始配置</p><p>修改redis-6.2.4/redis.conf文件，将其中的持久化模式改为默认的RDB模式，AOF保持关闭状态。</p><div class="code-wrapper"><pre><code class="hljs properties"><span class="hljs-comment"># 开启RDB</span>
<span class="hljs-comment"># save &quot;&quot;</span>
<span class="hljs-attr">save</span> <span class="hljs-string">3600 1</span>
<span class="hljs-attr">save</span> <span class="hljs-string">300 100</span>
<span class="hljs-attr">save</span> <span class="hljs-string">60 10000</span>
<span class="hljs-comment"></span>
<span class="hljs-comment"># 关闭AOF</span>
<span class="hljs-attr">appendonly</span> <span class="hljs-string">no</span></code></pre></div><p>3）拷贝配置文件到每个实例目录</p><p>然后将redis-6.2.4/redis.conf文件拷贝到三个目录中（在/tmp目录执行下列命令）：</p><div class="code-wrapper"><pre><code class="hljs sh"><span class="hljs-comment"># 方式一：逐个拷贝</span>
<span class="hljs-built_in">cp</span> redis-6.2.4/redis.conf 7001
<span class="hljs-built_in">cp</span> redis-6.2.4/redis.conf 7002
<span class="hljs-built_in">cp</span> redis-6.2.4/redis.conf 7003

<span class="hljs-comment"># 方式二：管道组合命令，一键拷贝</span>
<span class="hljs-built_in">echo</span> 7001 7002 7003 | xargs -t -n 1 <span class="hljs-built_in">cp</span> redis-6.2.4/redis.conf</code></pre></div><p>4）修改每个实例的端口、工作目录</p><p>修改每个文件夹内的配置文件，将端口分别修改为7001、7002、7003，将rdb文件保存位置都修改为自己所在目录（在/tmp目录执行下列命令）：</p><div class="code-wrapper"><pre><code class="hljs sh">sed -i -e <span class="hljs-string">&#x27;s/6379/7001/g&#x27;</span> -e <span class="hljs-string">&#x27;s/dir .\//dir \/tmp\/7001\//g&#x27;</span> 7001/redis.conf
sed -i -e <span class="hljs-string">&#x27;s/6379/7002/g&#x27;</span> -e <span class="hljs-string">&#x27;s/dir .\//dir \/tmp\/7002\//g&#x27;</span> 7002/redis.conf
sed -i -e <span class="hljs-string">&#x27;s/6379/7003/g&#x27;</span> -e <span class="hljs-string">&#x27;s/dir .\//dir \/tmp\/7003\//g&#x27;</span> 7003/redis.conf</code></pre></div><p>5）修改每个实例的声明IP</p><p>虚拟机本身有多个IP，为了避免将来混乱，我们需要在redis.conf文件中指定每一个实例的绑定ip信息，格式如下：</p><div class="code-wrapper"><pre><code class="hljs properties"><span class="hljs-comment"># redis实例的声明 IP</span>
<span class="hljs-attr">replica-announce-ip</span> <span class="hljs-string">192.168.150.101</span></code></pre></div><p>每个目录都要改，我们一键完成修改（在/tmp目录执行下列命令）：</p><div class="code-wrapper"><pre><code class="hljs sh"><span class="hljs-comment"># 逐一执行</span>
sed -i <span class="hljs-string">&#x27;1a replica-announce-ip 192.168.150.101&#x27;</span> 7001/redis.conf
sed -i <span class="hljs-string">&#x27;1a replica-announce-ip 192.168.150.101&#x27;</span> 7002/redis.conf
sed -i <span class="hljs-string">&#x27;1a replica-announce-ip 192.168.150.101&#x27;</span> 7003/redis.conf

<span class="hljs-comment"># 或者一键修改</span>
<span class="hljs-built_in">printf</span> <span class="hljs-string">&#x27;%s\n&#x27;</span> 7001 7002 7003 | xargs -I&#123;&#125; -t sed -i <span class="hljs-string">&#x27;1a replica-announce-ip 192.168.181.100&#x27;</span> &#123;&#125;/redis.conf</code></pre></div><h2 id="启动">2.3.启动</h2><p>为了方便查看日志，我们打开3个ssh窗口，分别启动3个redis实例，启动命令：</p><div class="code-wrapper"><pre><code class="hljs sh"><span class="hljs-comment"># 第1个</span>
redis-server 7001/redis.conf
<span class="hljs-comment"># 第2个</span>
redis-server 7002/redis.conf
<span class="hljs-comment"># 第3个</span>
redis-server 7003/redis.conf</code></pre></div><p>启动后：</p><figure><img src="https://gitee.com/cmyk359/img/raw/master/img/image-20210630183914491-2024-12-2416:49:51.png" srcset="/img/loading.gif" lazyload alt="image-20210630183914491"><figcaption aria-hidden="true">image-20210630183914491</figcaption></figure><p>如果要一键停止，可以运行下面命令：</p><div class="code-wrapper"><pre><code class="hljs sh"><span class="hljs-built_in">printf</span> <span class="hljs-string">&#x27;%s\n&#x27;</span> 7001 7002 7003 | xargs -I&#123;&#125; -t redis-cli -p &#123;&#125; shutdown</code></pre></div><h2 id="开启主从关系">2.4.开启主从关系</h2><p>现在三个实例还没有任何关系，要配置主从可以使用replicaof 或者slaveof（5.0以前）命令。</p><p>有临时和永久两种模式：</p><ul><li><p>修改配置文件（永久生效）</p><ul><li>在redis.conf中添加一行配置：<code>slaveof &lt;masterip&gt; &lt;masterport&gt;</code></li></ul></li><li><p>使用redis-cli客户端连接到redis服务，执行slaveof命令（重启后失效）：</p><div class="code-wrapper"><pre><code class="hljs sh">slaveof &lt;masterip&gt; &lt;masterport&gt;</code></pre></div></li></ul><p><strong><font color="red">注意</font></strong>：在5.0以后新增命令replicaof，与salveof效果一致。</p><p>这里我们为了演示方便，使用方式二。</p><p>通过redis-cli命令连接7002，执行下面命令：</p><div class="code-wrapper"><pre><code class="hljs sh"><span class="hljs-comment"># 连接 7002</span>
redis-cli -p 7002
<span class="hljs-comment"># 执行slaveof</span>
slaveof 192.168.150.101 7001</code></pre></div><p>通过redis-cli命令连接7003，执行下面命令：</p><div class="code-wrapper"><pre><code class="hljs sh"><span class="hljs-comment"># 连接 7003</span>
redis-cli -p 7003
<span class="hljs-comment"># 执行slaveof</span>
slaveof 192.168.150.101 7001</code></pre></div><p>然后连接 7001节点，查看集群状态：</p><div class="code-wrapper"><pre><code class="hljs sh"><span class="hljs-comment"># 连接 7001</span>
redis-cli -p 7001
<span class="hljs-comment"># 查看状态</span>
info replication</code></pre></div><p>结果：</p><figure><img src="https://gitee.com/cmyk359/img/raw/master/img/image-20210630201258802-2024-12-2416:49:57.png" srcset="/img/loading.gif" lazyload alt="image-20210630201258802"><figcaption aria-hidden="true">image-20210630201258802</figcaption></figure><h2 id="测试">2.5.测试</h2><p>执行下列操作以测试：</p><ul><li><p>利用redis-cli连接7001，执行<code>set num 123</code></p></li><li><p>利用redis-cli连接7002，执行<code>get num</code>，再执行<code>set num 666</code></p></li><li><p>利用redis-cli连接7003，执行<code>get num</code>，再执行<code>set num 888</code></p></li></ul><p>可以发现，只有在7001这个master节点上可以执行写操作，7002和7003这两个slave节点只能执行读操作。</p><h1 id="搭建哨兵集群">3.搭建哨兵集群</h1><h2 id="集群结构-1">3.1.集群结构</h2><p>这里我们搭建一个三节点形成的Sentinel集群，来监管之前的Redis主从集群。如图：</p><figure><img src="https://gitee.com/cmyk359/img/raw/master/img/image-20210701215227018-2024-12-2416:49:59.png" srcset="/img/loading.gif" lazyload alt="image-20210701215227018"><figcaption aria-hidden="true">image-20210701215227018</figcaption></figure><p>三个sentinel实例信息如下：</p><table><thead><tr class="header"><th>节点</th><th style="text-align:center">IP</th><th style="text-align:center">PORT</th></tr></thead><tbody><tr class="odd"><td>s1</td><td style="text-align:center">192.168.150.101</td><td style="text-align:center">27001</td></tr><tr class="even"><td>s2</td><td style="text-align:center">192.168.150.101</td><td style="text-align:center">27002</td></tr><tr class="odd"><td>s3</td><td style="text-align:center">192.168.150.101</td><td style="text-align:center">27003</td></tr></tbody></table><h2 id="准备实例和配置-1">3.2.准备实例和配置</h2><p>要在同一台虚拟机开启3个实例，必须准备三份不同的配置文件和目录，配置文件所在目录也就是工作目录。</p><p>我们创建三个文件夹，名字分别叫s1、s2、s3：</p><div class="code-wrapper"><pre><code class="hljs sh"><span class="hljs-comment"># 进入/tmp目录</span>
<span class="hljs-built_in">cd</span> /tmp
<span class="hljs-comment"># 创建目录</span>
<span class="hljs-built_in">mkdir</span> s1 s2 s3</code></pre></div><p>如图：</p><figure><img src="https://gitee.com/cmyk359/img/raw/master/img/image-20210701215534714-2024-12-2416:50:03.png" srcset="/img/loading.gif" lazyload alt="image-20210701215534714"><figcaption aria-hidden="true">image-20210701215534714</figcaption></figure><p>然后我们在s1目录创建一个sentinel.conf文件，添加下面的内容：</p><div class="code-wrapper"><pre><code class="hljs ini">port 27001
sentinel announce-ip 192.168.150.101
sentinel monitor mymaster 192.168.150.101 7001 2
sentinel down-after-milliseconds mymaster 5000
sentinel failover-timeout mymaster 60000
dir &quot;/tmp/s1&quot;</code></pre></div><p>解读：</p><ul><li><code>port 27001</code>：是当前sentinel实例的端口</li><li><code>sentinel monitor mymaster 192.168.150.101 7001 2</code>：指定主节点信息<ul><li><code>mymaster</code>：主节点名称，自定义，任意写</li><li><code>192.168.150.101 7001</code>：主节点的ip和端口</li><li><code>2</code>：选举master时的quorum值</li></ul></li></ul><p>然后将s1/sentinel.conf文件拷贝到s2、s3两个目录中（在/tmp目录执行下列命令）：</p><div class="code-wrapper"><pre><code class="hljs sh"><span class="hljs-comment"># 方式一：逐个拷贝</span>
<span class="hljs-built_in">cp</span> s1/sentinel.conf s2
<span class="hljs-built_in">cp</span> s1/sentinel.conf s3
<span class="hljs-comment"># 方式二：管道组合命令，一键拷贝</span>
<span class="hljs-built_in">echo</span> s2 s3 | xargs -t -n 1 <span class="hljs-built_in">cp</span> s1/sentinel.conf</code></pre></div><p>修改s2、s3两个文件夹内的配置文件，将端口分别修改为27002、27003：</p><div class="code-wrapper"><pre><code class="hljs sh">sed -i -e <span class="hljs-string">&#x27;s/27001/27002/g&#x27;</span> -e <span class="hljs-string">&#x27;s/s1/s2/g&#x27;</span> s2/sentinel.conf
sed -i -e <span class="hljs-string">&#x27;s/27001/27003/g&#x27;</span> -e <span class="hljs-string">&#x27;s/s1/s3/g&#x27;</span> s3/sentinel.conf</code></pre></div><h2 id="启动-1">3.3.启动</h2><p>为了方便查看日志，我们打开3个ssh窗口，分别启动3个redis实例，启动命令：</p><div class="code-wrapper"><pre><code class="hljs sh"><span class="hljs-comment"># 第1个</span>
redis-sentinel s1/sentinel.conf
<span class="hljs-comment"># 第2个</span>
redis-sentinel s2/sentinel.conf
<span class="hljs-comment"># 第3个</span>
redis-sentinel s3/sentinel.conf</code></pre></div><p>启动后：</p><figure><img src="https://gitee.com/cmyk359/img/raw/master/img/image-20210701220714104-2024-12-2416:50:06.png" srcset="/img/loading.gif" lazyload alt="image-20210701220714104"><figcaption aria-hidden="true">image-20210701220714104</figcaption></figure><h2 id="测试-1">3.4.测试</h2><p>尝试让master节点7001宕机，查看sentinel日志：</p><figure><img src="https://gitee.com/cmyk359/img/raw/master/img/image-20210701222857997-2024-12-2416:50:09.png" srcset="/img/loading.gif" lazyload alt="image-20210701222857997"><figcaption aria-hidden="true">image-20210701222857997</figcaption></figure><p>查看7003的日志：</p><figure><img src="https://gitee.com/cmyk359/img/raw/master/img/image-20210701223025709-2024-12-2416:50:11.png" srcset="/img/loading.gif" lazyload alt="image-20210701223025709"><figcaption aria-hidden="true">image-20210701223025709</figcaption></figure><p>查看7002的日志：</p><figure><img src="https://gitee.com/cmyk359/img/raw/master/img/image-20210701223131264-2024-12-2416:50:13.png" srcset="/img/loading.gif" lazyload alt="image-20210701223131264"><figcaption aria-hidden="true">image-20210701223131264</figcaption></figure><h1 id="搭建分片集群">4.搭建分片集群</h1><h2 id="集群结构-2">4.1.集群结构</h2><p>分片集群需要的节点数量较多，这里我们搭建一个最小的分片集群，包含3个master节点，每个master包含一个slave节点，结构如下：</p><figure><img src="https://gitee.com/cmyk359/img/raw/master/img/image-20210702164116027-2024-12-2416:50:16.png" srcset="/img/loading.gif" lazyload alt="image-20210702164116027"><figcaption aria-hidden="true">image-20210702164116027</figcaption></figure><p>这里我们会在同一台虚拟机中开启6个redis实例，模拟分片集群，信息如下：</p><table><thead><tr class="header"><th style="text-align:center">IP</th><th style="text-align:center">PORT</th><th style="text-align:center">角色</th></tr></thead><tbody><tr class="odd"><td style="text-align:center">192.168.150.101</td><td style="text-align:center">7001</td><td style="text-align:center">master</td></tr><tr class="even"><td style="text-align:center">192.168.150.101</td><td style="text-align:center">7002</td><td style="text-align:center">master</td></tr><tr class="odd"><td style="text-align:center">192.168.150.101</td><td style="text-align:center">7003</td><td style="text-align:center">master</td></tr><tr class="even"><td style="text-align:center">192.168.150.101</td><td style="text-align:center">8001</td><td style="text-align:center">slave</td></tr><tr class="odd"><td style="text-align:center">192.168.150.101</td><td style="text-align:center">8002</td><td style="text-align:center">slave</td></tr><tr class="even"><td style="text-align:center">192.168.150.101</td><td style="text-align:center">8003</td><td style="text-align:center">slave</td></tr></tbody></table><h2 id="准备实例和配置-2">4.2.准备实例和配置</h2><p>删除之前的7001、7002、7003这几个目录，重新创建出7001、7002、7003、8001、8002、8003目录：</p><div class="code-wrapper"><pre><code class="hljs sh"><span class="hljs-comment"># 进入/tmp目录</span>
<span class="hljs-built_in">cd</span> /tmp
<span class="hljs-comment"># 删除旧的，避免配置干扰</span>
<span class="hljs-built_in">rm</span> -rf 7001 7002 7003
<span class="hljs-comment"># 创建目录</span>
<span class="hljs-built_in">mkdir</span> 7001 7002 7003 8001 8002 8003</code></pre></div><p>在/tmp下准备一个新的redis.conf文件，内容如下：</p><div class="code-wrapper"><pre><code class="hljs ini">port 6379
<span class="hljs-comment"># 开启集群功能</span>
cluster-enabled yes
<span class="hljs-comment"># 集群的配置文件名称，不需要我们创建，由redis自己维护</span>
cluster-config-file /tmp/6379/nodes.conf
<span class="hljs-comment"># 节点心跳失败的超时时间</span>
cluster-node-timeout 5000
<span class="hljs-comment"># 持久化文件存放目录</span>
dir /tmp/6379
<span class="hljs-comment"># 绑定地址</span>
bind 0.0.0.0
<span class="hljs-comment"># 让redis后台运行</span>
daemonize yes
<span class="hljs-comment"># 注册的实例ip</span>
replica-announce-ip 192.168.150.101
<span class="hljs-comment"># 保护模式</span>
protected-mode no
<span class="hljs-comment"># 数据库数量</span>
databases 1
<span class="hljs-comment"># 日志</span>
logfile /tmp/6379/run.log</code></pre></div><p>将这个文件拷贝到每个目录下：</p><div class="code-wrapper"><pre><code class="hljs sh"><span class="hljs-comment"># 进入/tmp目录</span>
<span class="hljs-built_in">cd</span> /tmp
<span class="hljs-comment"># 执行拷贝</span>
<span class="hljs-built_in">echo</span> 7001 7002 7003 8001 8002 8003 | xargs -t -n 1 <span class="hljs-built_in">cp</span> redis.conf</code></pre></div><p>修改每个目录下的redis.conf，将其中的6379修改为与所在目录一致：</p><div class="code-wrapper"><pre><code class="hljs sh"><span class="hljs-comment"># 进入/tmp目录</span>
<span class="hljs-built_in">cd</span> /tmp
<span class="hljs-comment"># 修改配置文件</span>
<span class="hljs-built_in">printf</span> <span class="hljs-string">&#x27;%s\n&#x27;</span> 7001 7002 7003 8001 8002 8003 | xargs -I&#123;&#125; -t sed -i <span class="hljs-string">&#x27;s/6379/&#123;&#125;/g&#x27;</span> &#123;&#125;/redis.conf</code></pre></div><h2 id="启动-2">4.3.启动</h2><p>因为已经配置了后台启动模式，所以可以直接启动服务：</p><div class="code-wrapper"><pre><code class="hljs sh"><span class="hljs-comment"># 进入/tmp目录</span>
<span class="hljs-built_in">cd</span> /tmp
<span class="hljs-comment"># 一键启动所有服务</span>
<span class="hljs-built_in">printf</span> <span class="hljs-string">&#x27;%s\n&#x27;</span> 7001 7002 7003 8001 8002 8003 | xargs -I&#123;&#125; -t redis-server &#123;&#125;/redis.conf</code></pre></div><p>通过ps查看状态：</p><div class="code-wrapper"><pre><code class="hljs sh">ps -ef | grep redis</code></pre></div><p>发现服务都已经正常启动：</p><figure><img src="https://gitee.com/cmyk359/img/raw/master/img/image-20210702174255799-2024-12-2416:50:21.png" srcset="/img/loading.gif" lazyload alt="image-20210702174255799"><figcaption aria-hidden="true">image-20210702174255799</figcaption></figure><p>如果要关闭所有进程，可以执行命令：</p><div class="code-wrapper"><pre><code class="hljs sh">ps -ef | grep redis | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span> | xargs <span class="hljs-built_in">kill</span></code></pre></div><p>或者（推荐这种方式）：</p><div class="code-wrapper"><pre><code class="hljs sh"><span class="hljs-built_in">printf</span> <span class="hljs-string">&#x27;%s\n&#x27;</span> 7001 7002 7003 8001 8002 8003 | xargs -I&#123;&#125; -t redis-cli -p &#123;&#125; shutdown</code></pre></div><h2 id="创建集群">4.4.创建集群</h2><p>虽然服务启动了，但是目前每个服务之间都是独立的，没有任何关联。</p><p>我们需要执行命令来创建集群，在Redis5.0之前创建集群比较麻烦，5.0之后集群管理命令都集成到了redis-cli中。</p><p>1）Redis5.0之前</p><p>Redis5.0之前集群命令都是用redis安装包下的src/redis-trib.rb来实现的。因为redis-trib.rb是有ruby语言编写的所以需要安装ruby环境。</p><p></p><div class="code-wrapper"><pre><code class="hljs sh"><span class="hljs-comment"># 安装依赖</span>
yum -y install zlib ruby rubygems
gem install redis</code></pre></div><p></p><p>然后通过命令来管理集群：</p><div class="code-wrapper"><pre><code class="hljs sh"><span class="hljs-comment"># 进入redis的src目录</span>
<span class="hljs-built_in">cd</span> /tmp/redis-6.2.4/src
<span class="hljs-comment"># 创建集群</span>
./redis-trib.rb create --replicas 1 192.168.150.101:7001 192.168.150.101:7002 192.168.150.101:7003 192.168.150.101:8001 192.168.150.101:8002 192.168.150.101:8003</code></pre></div><p>2）Redis5.0以后</p><p>我们使用的是Redis6.2.4版本，集群管理以及集成到了redis-cli中，格式如下：</p><div class="code-wrapper"><pre><code class="hljs sh">redis-cli --cluster create --cluster-replicas 1 192.168.150.101:7001 192.168.150.101:7002 192.168.150.101:7003 192.168.150.101:8001 192.168.150.101:8002 192.168.150.101:8003</code></pre></div><p>命令说明：</p><ul><li><code>redis-cli --cluster</code>或者<code>./redis-trib.rb</code>：代表集群操作命令</li><li><code>create</code>：代表是创建集群</li><li><code>--replicas 1</code>或者<code>--cluster-replicas 1</code> ：指定集群中每个master的副本个数为1，此时<code>节点总数 ÷ (replicas + 1)</code> 得到的就是master的数量。因此节点列表中的前n个就是master，其它节点都是slave节点，随机分配到不同master</li></ul><p>运行后的样子：</p><figure><img src="https://gitee.com/cmyk359/img/raw/master/img/image-20210702181101969-2024-12-2416:50:24.png" srcset="/img/loading.gif" lazyload alt="image-20210702181101969"><figcaption aria-hidden="true">image-20210702181101969</figcaption></figure><p>这里输入yes，则集群开始创建：</p><figure><img src="https://gitee.com/cmyk359/img/raw/master/img/image-20210702181215705-2024-12-2416:50:26.png" srcset="/img/loading.gif" lazyload alt="image-20210702181215705"><figcaption aria-hidden="true">image-20210702181215705</figcaption></figure><p>通过命令可以查看集群状态：</p><div class="code-wrapper"><pre><code class="hljs sh">redis-cli -p 7001 cluster nodes</code></pre></div><figure><img src="https://gitee.com/cmyk359/img/raw/master/img/image-20210702181922809-2024-12-2416:50:28.png" srcset="/img/loading.gif" lazyload alt="image-20210702181922809"><figcaption aria-hidden="true">image-20210702181922809</figcaption></figure><h2 id="测试-2">4.5.测试</h2><p>尝试连接7001节点，存储一个数据：</p><div class="code-wrapper"><pre><code class="hljs sh"><span class="hljs-comment"># 连接</span>
redis-cli -p 7001
<span class="hljs-comment"># 存储数据</span>
<span class="hljs-built_in">set</span> num 123
<span class="hljs-comment"># 读取数据</span>
get num
<span class="hljs-comment"># 再次存储</span>
<span class="hljs-built_in">set</span> a 1</code></pre></div><p>结果悲剧了：</p><figure><img src="https://gitee.com/cmyk359/img/raw/master/img/image-20210702182343979-2024-12-2416:50:34.png" srcset="/img/loading.gif" lazyload alt="image-20210702182343979"><figcaption aria-hidden="true">image-20210702182343979</figcaption></figure><p>集群操作时，需要给<code>redis-cli</code>加上<code>-c</code>参数才可以：</p><div class="code-wrapper"><pre><code class="hljs sh">redis-cli -c -p 7001</code></pre></div><p>这次可以了：</p><figure><img src="https://gitee.com/cmyk359/img/raw/master/img/image-20210702182602145-2024-12-2416:50:36.png" srcset="/img/loading.gif" lazyload alt="image-20210702182602145"><figcaption aria-hidden="true">image-20210702182602145</figcaption></figure></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E6%95%99%E7%A8%8B/" class="category-chain-item">环境搭建教程</a></span></span></div></div><div class="license-box my-3"><div class="license-title"><div>Redis集群搭建</div><div>http://catpaws.top/3e4345d9/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>猫爪在上</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2024年12月24日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-cc-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div></div><article id="comments" lazyload><div id="twikoo"></div><script type="text/javascript">Fluid.utils.loadComments("#comments",(function(){Fluid.utils.createScript("https://cdn.smartcis.cn/npm/twikoo@1.6.40/dist/twikoo.all.min.js",(function(){var t=Object.assign({envId:"https://catpaws-comments.netlify.app/.netlify/functions/twikoo",region:"ap-shanghai",path:"window.location.pathname"},{el:"#twikoo",path:"window.location.pathname",onCommentLoaded:function(){Fluid.utils.listenDOMLoaded((function(){var t="#twikoo .tk-content img:not(.tk-owo-emotion)";Fluid.plugins.imageCaption(t),Fluid.plugins.fancyBox(t)}))}});twikoo.init(t)}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><script>Fluid.utils.createScript("https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js",(function(){mermaid.initialize({theme:"default"}),Fluid.utils.listenDOMLoaded((function(){Fluid.events.registerRefreshCallback((function(){"mermaid"in window&&mermaid.init()}))}))}))</script><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a><br>人山人海，欢迎你的到来 <i class="iconfont icon-love"></i><br><span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script defer src="/js/leancloud.js"></script><script src="/js/local-search.js"></script><script src="//cdn.jsdelivr.net/gh/cmyk359/MyCDN/Hexo/source/js/timeDate.js"></script><script src="//sdk.jinrishici.com/v2/browser/jinrishici.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript><script data-pjax src="https://unpkg.com/oh-my-live2d"></script><script>const oml2d=OML2D.loadOml2d({dockedPosition:"left",mobileDisplay:!1,models:[{path:"https://cdn.jsdelivr.net/gh/cmyk359/MyCDN/Hexo/static/live2d/Frieren/Frieren.model3.json",motionPreloadStrategy:"IDLE",position:[-60,-100],scale:.06,stageStyle:{width:250,height:350}}],parentElement:document.body,primaryColor:"var(--btn-bg)",sayHello:!1,tips:{style:{width:200,height:90,left:"calc(50% - 20px)",top:"-100px","font-size":"14px"},idleTips:{interval:15e3,message:function(){return axios.get("https://v1.hitokoto.cn?c=i").then((function(t){return t.data.hitokoto})).catch((function(t){console.error(t)}))}}}})</script></body></html>